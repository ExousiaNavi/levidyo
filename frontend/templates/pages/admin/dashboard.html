{% extends "base.html" %} {% import 'pages/admin/components/card.html' as cards
%} {% import 'pages/admin/components/deposit-chart.html' as charts %} {% block
content %}

<!-- Skeleton Loader -->
<div id="skeleton-loader" class="grid grid-cols-1 lg:grid-cols-2 gap-4 animate-pulse p-4">
  <!-- Left: Deposit Overview Placeholder -->
  <div class="space-y-4">
    <!-- Title Placeholder -->
    <div class="h-6 w-1/3 bg-gray-300 rounded"></div>

    <!-- KPI Cards -->
    <div class="grid grid-cols-3 gap-3">
      <div class="h-24 bg-gray-200 rounded-lg"></div>
      <div class="h-24 bg-gray-200 rounded-lg"></div>
      <div class="h-24 bg-gray-200 rounded-lg"></div>
    </div>

    <!-- Deposit Log Placeholder -->
    <div class="h-[calc(100vh-250px)] bg-gray-200 rounded-lg"></div>
  </div>

  <!-- Right: Charts Placeholder -->
  <div class="space-y-4">
    <div class="h-64 bg-gray-200 rounded-lg flex flex-col justify-center items-center">
      <div class="h-6 w-1/4 bg-gray-300 rounded mb-2"></div>
      <div class="h-40 w-11/12 bg-gray-300 rounded"></div>
    </div>
    <div class="h-64 bg-gray-200 rounded-lg flex flex-col justify-center items-center">
      <div class="h-6 w-1/4 bg-gray-300 rounded mb-2"></div>
      <div class="h-40 w-11/12 bg-gray-300 rounded"></div>
    </div>
  </div>
</div>


<div id="dashboard-content" class="hidden">
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 overflow-y-auto">
    <!-- ðŸŸ¢ Deposit Overview Card -->
    <div id="deposit-card">
      {{ cards.deposit_card(kpis, target, history_log, current_datetime, brands,
      available_currencies) }}
    </div>

    <!-- ðŸ“ˆ Charts Section -->
    <div id="charts" class="grid grid-cols-1 gap-3">
      <!-- Hourly Chart Card -->
      <div class="bg-white shadow rounded-lg p-4">
        <h3 class="text-sm font-medium text-gray-700 mb-2">Hourly Chart</h3>
        <canvas id="hourlyChart" class="w-full h-64"></canvas>
      </div>

      <!-- Previous Day Chart Card -->
      <div id="prev-chart" class="bg-white shadow rounded-lg p-4">
        <h3 class="text-sm font-medium text-gray-700 mb-2">
          Previous Day Chart
        </h3>
        <canvas id="previousDayChart" class="w-full h-64"></canvas>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  let hourlyChart, previousDayChart;

  function formatNumber(value, minDigits = 2, maxDigits = 2) {
    return Number(value).toLocaleString(undefined, {
      minimumFractionDigits: minDigits,
      maximumFractionDigits: maxDigits,
    });
  }

  function updatePendingWithdraw(kpis, target, $container) {
    $("#pending-deposit-container").addClass("hidden")
    const metrics = [
      {
        label: "Pending Wd. Amount",
        value: kpis.total_pending_withdraw_amount,
      },
      { label: "Pending Wd. Count", value: kpis.total_pending_withdraw_count },
      { label: "Average Time", value: kpis.average_pending_time },
    ];
    metrics.forEach((metric) => {
      const { svg, cssClass } = getBadgeClassAndArrow(metric.value ?? 0);
      $container.append(`
        <div class="p-3 rounded-lg shadow-sm ${cssClass} flex flex-col items-center justify-center animate__animated animate__fadeIn">
          <div class="flex items-center gap-2">
            <span class="text-sm font-semibold">${
              formatNumber(metric.value) ?? 0
            }</span>
          </div>
          <div class="text-[11px] font-medium uppercase mt-1 tracking-wide text-center">${
            metric.label
          }</div>
        </div>
      `);
    });
    $("#stats-container").hide();
    $("#prev-chart").hide();
    $("#target_progress_container").hide();
    $("#td_deposit").text("");
    $("#ld_cumulative").text("");
    $("#lastd_deposit").text("");
    const percentage = 0;
    $("#progress-fill").animate({ width: `${percentage}%` }, 600);
  }

  function updatePendingDeposit(kpis, target, $container) {
    $("#pending-withdraw-container").addClass("hidden")
    const metrics = [
      { label: "Pending Dp. Amount", value: kpis.total_pending_deposit_amount },
      { label: "Pending Dp. Count", value: kpis.total_pending_deposit_count },
      { label: "Average Time", value: kpis.average_pending_time },
    ];
    metrics.forEach((metric) => {
      const { svg, cssClass } = getBadgeClassAndArrow(metric.value ?? 0);
      $container.append(`
        <div class="p-3 rounded-lg shadow-sm ${cssClass} flex flex-col items-center justify-center animate__animated animate__fadeIn">
          <div class="flex items-center gap-2">
            <span class="text-sm font-semibold">${
              formatNumber(metric.value) ?? 0
            }</span>
          </div>
          <div class="text-[11px] font-medium uppercase mt-1 tracking-wide text-center">${
            metric.label
          }</div>
        </div>
      `);
    });
    $("#stats-container").hide();
    $("#prev-chart").hide();
    $("#target_progress_container").hide();
    $("#td_deposit").text("");
    $("#ld_cumulative").text("");
    $("#lastd_deposit").text("");
    const percentage = 0;
    $("#progress-fill").animate({ width: `${percentage}%` }, 600);
  }

  function getBadgeClassAndArrow(delta) {
    let svg = "",
      cssClass = "";
    if (delta >= 11) {
      svg = `<svg class='w-4 h-4 mr-1 shrink-0' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 19V5m0 0l-6 6m6-6l6 6'/></svg>`;
      cssClass = "text-green-700 bg-green-100";
    } else if (delta >= 1) {
      svg = `<svg class='w-4 h-4 mr-1 shrink-0' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M7 17L17 7m0 0h-6m6 0v6'/></svg>`;
      cssClass = "text-blue-700 bg-blue-100";
    } else if (delta > -11) {
      svg = `<svg class='w-4 h-4 mr-1 shrink-0' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M7 7l10 10m0 0h-6m6 0v-6'/></svg>`;
      cssClass = "text-orange-700 bg-orange-100";
    } else if (delta <= -11) {
      svg = `<svg class='w-4 h-4 mr-1 shrink-0' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 5v14m0 0l6-6m-6 6l-6-6'/></svg>`;
      cssClass = "text-red-700 bg-red-100";
    } else {
      svg = `<svg class='w-4 h-4 mr-1 shrink-0' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M5 12h14'/></svg>`;
      cssClass = "text-gray-600 bg-gray-100";
    }
    return { svg, cssClass };
  }

  function updateKpi(kpis, target, $container) {
    $("#pending-withdraw-container").addClass("hidden")
    $("#pending-deposit-container").addClass("hidden")
    const metrics = [
      { label: "HDoD", value: kpis.hdod },
      { label: "HWoW", value: kpis.hwow },
      { label: "CDoD", value: kpis.cdod },
      { label: "CWoW", value: kpis.cwow },
    ];
    metrics.forEach((metric) => {
      const { svg, cssClass } = getBadgeClassAndArrow(metric.value ?? 0);
      $container.append(`
        <div class="p-3 rounded-lg shadow-sm ${cssClass} flex flex-col items-center justify-center animate__animated animate__fadeIn">
          <div class="flex items-center gap-2">
            <div class="w-4 h-4">${svg}</div>
            <span class="text-sm font-semibold">${metric.value ?? 0}%</span>
          </div>
          <div class="text-[11px] font-medium uppercase mt-1 tracking-wide">${
            metric.label
          }</div>
        </div>
      `);
    });
    $("#td_deposit").text(formatNumber(kpis.today_deposit));
    $("#ld_cumulative").text(formatNumber(kpis.ld_cumulative));
    $("#lastd_deposit").text(formatNumber(kpis.ld_deposit));
    const percentage = ((kpis.ld_deposit / target) * 100).toFixed(1);
    $("#progress-fill").animate({ width: `${percentage}%` }, 600);
  }

  function buildCharts(
    chartHours,
    todayData,
    cumulativeData,
    lastDayData,
    lastCumulativeData
  ) {
    if (hourlyChart) hourlyChart.destroy();
    if (previousDayChart) previousDayChart.destroy();
    hourlyChart = new Chart($("#hourlyChart")[0], {
      type: "line",
      data: {
        labels: chartHours,
        datasets: [
          {
            label: "Current",
            data: todayData,
            borderColor: "#10B981",
            tension: 0.4,
            fill: false,
          },
          {
            label: "Cumulative",
            data: cumulativeData,
            borderColor: "#3B82F6",
            tension: 0.4,
            fill: false,
          },
        ],
      },
      options: {
        responsive: true,
        plugins: { legend: { position: "bottom" } },
        scales: { y: { beginAtZero: true } },
      },
    });
    previousDayChart = new Chart($("#previousDayChart")[0], {
      type: "bar",
      data: {
        labels: chartHours,
        datasets: [
          { label: "Last Day", data: lastDayData, backgroundColor: "#F59E0B" },
          {
            label: "Last Cumulative",
            data: lastCumulativeData,
            backgroundColor: "#A78BFA",
          },
        ],
      },
      options: {
        responsive: true,
        plugins: { legend: { position: "bottom" } },
        scales: { y: { beginAtZero: true } },
      },
    });
  }

  function updateHistory(history, $logList, sub) {
    if (sub === "deposit" || sub === "withdraw") {
      history.forEach((entry) => {
        const logHtml = `
            <li class="bg-white border rounded-lg p-2 shadow-sm hover:shadow transition animate__animated animate__fadeIn">
              <div class="flex justify-between font-medium mb-1">
                <span class="text-green-700">HR-${entry.time}</span>
                <span class="text-gray-800">${formatNumber(entry.amount)}</span>
              </div>
              <div class="flex flex-wrap gap-1">
                ${["hdod", "hwow", "cdod", "cwow"]
                  .map((label) => {
                    const value = entry[label] ?? 0;
                    const { svg, cssClass } = getBadgeClassAndArrow(value);
                    return `
                    <span class="flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium ${cssClass}">
                      ${svg}
                      ${label.toUpperCase()}: ${value}%
                    </span>`;
                  })
                  .join("")}

              </div>
            </li>`;
        $logList.append(logHtml);
      });
    } else if (sub === "pendingdeposit" || sub === "pendingwithdraw") {
      history.forEach((entry) => {
        const logHtml = `
            <li class="bg-white border rounded-lg p-2 shadow-sm hover:shadow transition animate__animated animate__fadeIn">
              <div class="flex justify-between font-medium mb-1">
                <span class="text-green-700">HR-${entry.time}</span>
                <span class="text-gray-800">${formatNumber(entry.amount)}</span>
              </div>
              <div class="flex flex-wrap gap-1">
                ${["amount", "count", "avg_time"]
                  .map((label) => {
                    const value = entry[label] ?? 0;
                    const { svg, cssClass } = getBadgeClassAndArrow(value);
                    return `
                    <span class="flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-green-100">
                      ${label.toUpperCase()}: ${formatNumber(value)}
                    </span>`;
                  })
                  .join("")}

              </div>
            </li>`;
        $logList.append(logHtml);
      });
    }
  }

  function updateDashboard(sub, tab) {
    console.log(sub, tab)
    // ðŸ”„ Show skeleton, hide real dashboard content
    $("#dashboard-content").hide();
    $("#skeleton-loader").show();
    
    const brand = $("#brand-select").val();
    const currency = $("#currency-select").val();
    $.getJSON(
      `/api/dashboard-data?brand=${brand}&currency=${currency}&table=${sub}&tab=${tab}`,
      function (data) {
        const kpis = data.kpis || {},
          target = data.target || 1,
          history = data.history_log || [];
        const width = ((kpis.today_deposit / target) * 100).toFixed(2);
        $("#progress-bar").width(`${width}%`);
        $("h2").text(`${tab} â€“ ${brand.toUpperCase()}`);
        buildCharts(
          data.chart_hours,
          data.today_values,
          data.cumulative_values,
          data.last_day_values,
          data.last_cumulative_values
        );
        let $container = $("#kpi-container").empty();
        let $pendingDepositContainer = $("#pending-deposit-container").empty();
        let $pendingWithdrawContainer = $(
          "#pending-withdraw-container"
        ).empty();
        if (tab === "Deposit" || tab === "Withdraw") {
          console.log(sub);
          updateKpi(kpis, target, $container);
        } else if (sub === "pendingdeposit") {
          updatePendingDeposit(kpis, target, $pendingDepositContainer);
        } else if (sub === "pendingwithdraw") {
          updatePendingWithdraw(kpis, target, $pendingWithdrawContainer);
        }
        const $logList = $("ul.space-y-2").empty();
        updateHistory(history, $logList, sub);

        // âœ… Fade out loader and show actual dashboard
        $("#skeleton-loader").fadeOut(200, function () {
          $("#dashboard-content").fadeIn(300);
        });
      }
    ).fail(function () {
    $("#skeleton-loader").html(`
      <div class="text-center text-red-600 font-bold p-4">
        ðŸ”´ Failed to load dashboard data. Please refresh or try again.
      </div>
    `);
  });
  }

  $(document).ready(function () {
    const params = new URLSearchParams(window.location.search);
    const sub = params.get("sub");
    let tab = "Deposit";
    const combinationTabs = [
      "Deposit",
      "Withdraw",
      "Pending Deposit",
      "Pending Withdraw",
    ];

    if (sub === "deposit") tab = combinationTabs[0];
    if (sub === "withdraw") tab = combinationTabs[1];
    if (sub === "pendingdeposit") tab = combinationTabs[2];
    if (sub === "pendingwithdraw") tab = combinationTabs[3];

    // ðŸ‘‡ Wrap inside a function to delay execution until the event is triggered
    $("#brand-select, #currency-select").on("change", function () {
      updateDashboard(sub, tab);
    });

    // Initial load
    updateDashboard(sub, tab);
  });
</script>
{% endblock %}
