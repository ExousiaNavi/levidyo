{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-gray-100 py-12 px-4">
  <div class="max-w-6xl mx-auto bg-white p-10 rounded-3xl shadow-2xl border border-gray-200">
    <h1 class="text-4xl font-bold text-center text-gray-800 mb-12 tracking-tight">üì∏ Camera Tool</h1>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-12">

      <!-- üî¥ Live Camera Section -->
      <div class="space-y-6">
        <h2 class="text-2xl font-semibold text-gray-700">Live Camera Feed</h2>

        <div class="aspect-video w-full rounded-xl overflow-hidden bg-black shadow-md border border-gray-300">
          <video id="video" class="w-full h-full object-cover" autoplay></video>
        </div>

        <canvas id="canvas" width="320" height="240" class="hidden"></canvas>

        <button id="capture"
          class="w-full px-6 py-3 bg-blue-600 text-white rounded-xl text-lg font-semibold shadow-md hover:bg-blue-700 hover:scale-105 active:scale-95 transition-transform duration-200">
          üì§ Capture & Upload
        </button>
      </div>

      <!-- üü¢ Encoded Images Gallery -->
      <div class="space-y-6">
        <h2 class="text-2xl font-semibold text-gray-700">Encoded Image Gallery</h2>

        <div id="encodedGalleryWrapper"
          class="max-h-[300px] overflow-y-auto border border-gray-300 rounded-xl p-3 bg-gray-50 shadow-inner">
          <div id="encodedGallery" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">
            <!-- thumbnails inserted here -->
          </div>
        </div>

        <button id="decodeBtnGallery"
          class="hidden w-full px-6 py-3 bg-green-600 text-white rounded-xl text-lg font-semibold shadow-md hover:bg-green-700 hover:scale-105 active:scale-95 transition-transform duration-200">
          üîç Decode Selected Image
        </button>

        <p id="decodedMessageGallery"
          class="text-center mt-4 text-base text-gray-800 font-mono break-words whitespace-pre-wrap px-2"></p>
      </div>
    </div>
  </div>
</div>

<style>
  #encodedGalleryWrapper::-webkit-scrollbar {
    width: 6px;
  }

  #encodedGalleryWrapper::-webkit-scrollbar-thumb {
    background-color: rgba(100, 100, 100, 0.2);
    border-radius: 4px;
  }

  /* Smooth image animations */
  #encodedGallery img {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  #encodedGallery img:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  #encodedGallery img:active {
    transform: scale(0.95);
  }
</style>

<script>
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const captureBtn = document.getElementById("capture");
  const encodedGallery = document.getElementById("encodedGallery");
  const decodeBtnGallery = document.getElementById("decodeBtnGallery");
  const decodedMessageGallery = document.getElementById("decodedMessageGallery");

  let selectedFilename = null;

  navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => video.srcObject = stream)
    .catch(console.error);

  captureBtn.onclick = () => {
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    canvas.toBlob(blob => {
      const formData = new FormData();
      formData.append("image", blob, "captured.png");
      formData.append("message", "hidden message here");

      fetch("/upload-image", {
        method: "POST",
        body: formData
      })
        .then(res => res.json())
        .then(() => loadGallery())
        .catch(console.error);
    }, "image/png");
  };

  function loadGallery() {
    fetch("/list-encoded-images")
      .then(res => res.json())
      .then(data => {
        encodedGallery.innerHTML = "";
        data.files.reverse().forEach(fn => {
          const img = document.createElement("img");
          img.src = data.base_url + fn;
          img.className = `
            cursor-pointer 
            rounded-xl 
            border-4 border-transparent 
            hover:border-blue-500
            active:border-green-500
            transition-all
          `.trim();

          img.dataset.filename = fn;

          img.onclick = () => {
            Array.from(encodedGallery.children).forEach(i =>
              i.classList.remove("border-blue-500", "border-green-500")
            );
            img.classList.add("border-blue-500");
            selectedFilename = fn;
            decodeBtnGallery.classList.remove("hidden");
          };

          encodedGallery.prepend(img);  // latest on top
        });
      })
      .catch(console.error);
  }

  decodeBtnGallery.onclick = () => {
    if (!selectedFilename) return;
    fetch(`/decode-image?filename=${selectedFilename}`)
      .then(res => res.json())
      .then(data => {
        decodedMessageGallery.textContent = "üß© Decoded Key: " + data.message;
      })
      .catch(console.error);
  };

  window.addEventListener("load", loadGallery);
</script>
{% endblock %}
