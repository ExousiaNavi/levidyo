{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-gray-100 py-10 px-4">
  <div class="max-w-6xl mx-auto bg-white p-8 rounded-2xl shadow-2xl">
    <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">Camera Tool</h1>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
      <!-- Left: Live Camera & Capture -->
      <div class="space-y-6">
        <h2 class="text-xl font-semibold text-gray-700">Live Camera Feed</h2>
        <div class="rounded-lg overflow-hidden shadow max-w-sm mx-auto aspect-video bg-black">
          <video id="video" class="w-full h-full object-cover" autoplay></video>
        </div>
        <canvas id="canvas" width="320" height="240" class="hidden"></canvas>
        <button id="capture"
          class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200">
          Capture & Upload
        </button>
      </div>

      <!-- Right: Encoded Image & Decode -->
      <div class="space-y-6" id="encodedSection">
        <h2 class="text-xl font-semibold text-gray-700">Encoded Image</h2>
        <img id="encodedImage" class="hidden rounded-lg w-full max-w-xs mx-auto shadow-lg" />

        <button id="decodeBtn"
          class="hidden w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-200">
          Decode Hidden Message
        </button>

        <div class="bg-gray-100 p-4 rounded-lg">
          <p id="decodedMessage" class="text-gray-800 font-mono text-center break-words"></p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const captureBtn = document.getElementById("capture");
  const encodedImage = document.getElementById("encodedImage");
  const decodeBtn = document.getElementById("decodeBtn");
  const decodedMessage = document.getElementById("decodedMessage");

  navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
    video.srcObject = stream;
  });

  captureBtn.onclick = () => {
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    canvas.toBlob(blob => {
      const formData = new FormData();
      formData.append("image", blob, "captured.png");
      formData.append("message", "hidden message here");

      fetch("/upload-image", {
        method: "POST",
        body: formData,
      })
      .then(res => res.json())
      .then(data => {
        encodedImage.src = data.image_url;
        encodedImage.classList.remove("hidden");
        decodeBtn.classList.remove("hidden");
        decodeBtn.dataset.filename = data.image_url.split("/").pop();
      });
    }, "image/png");
  };

  decodeBtn.onclick = () => {
    const filename = decodeBtn.dataset.filename;
    fetch(`/decode-image?filename=${filename}`)
      .then(res => res.json())
      .then(data => {
        decodedMessage.textContent = "Decoded Key: " + data.message;
      });
  };
</script>
{% endblock %}
